name: Email Traffic CSV

on:
  schedule:
    - cron: '5 1 * * *'   # 09:05 Asia/Taipei = 01:05 UTC
  workflow_dispatch: {}

jobs:
  send:
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v4

      - name: Fetch traffic -> CSV
        env:
          GITHUB_TOKEN: ${{ secrets.TRAFFIC_ISP }}   # fine-grained PAT with repo read/admin on this repo
        run: |
          sudo apt-get update && sudo apt-get install -y jq
          cat > gh_traffic_to_csv.sh <<'BASH'
          #!/usr/bin/env bash
          set -euo pipefail
          OWNER="advantech-EdgeAI"; REPO="edge_agent"; TYPE="views"; PER="day"; OUT="traffic_views.csv"
          JSON="$(curl -sS -H "Accept: application/vnd.github+json" \
                     -H "Authorization: Bearer ${GITHUB_TOKEN}" \
                     -H "X-GitHub-Api-Version: 2022-11-28" \
                     "https://api.github.com/repos/${OWNER}/${REPO}/traffic/${TYPE}?per=${PER}")"
          # Detect API error (e.g., permissions)
          if echo "$JSON" | jq -e 'has("message") and (."documentation_url" or .message)' >/dev/null; then
            echo "GitHub API error:" >&2
            echo "$JSON" | jq -r '.message // empty, ."documentation_url" // empty' >&2
            exit 1
          fi
          echo "timestamp,count,uniques" > "$OUT"
          # echo "$JSON" | jq -r '.views[] | [ .timestamp, .count, .uniques ] | @csv' >> "$OUT"
          echo "$JSON" | jq -r --arg t "$TYPE" '.[$t][] | [ .timestamp, (.count|tostring), (.uniques|tostring) ] | @csv' >> "$OUT"
          ls -l "$OUT"
          BASH
          chmod +x gh_traffic_to_csv.sh
          ./gh_traffic_to_csv.sh

      - name: Send email with attachment
        uses: dawidd6/action-send-mail@v3
        with:
          server_address: smtp.gmail.com
          server_port: 465
          secure: true          # <- IMPORTANT: STARTTLS, not SSL-on-connect
          username: ${{ secrets.SAE_GMAIL_ACC }}       # e.g., youraddress@gmail.com
          password: ${{ secrets.SAE_GMAIL_APP_PWD }}   # Gmail App Password
          subject: 'edge_agent daily traffic'
          to: sl.lin@advantech.com.tw
          from: ${{ secrets.SAE_GMAIL_ACC }}
          attachments: traffic_views.csv
          html_body: |
            <p>Hi,</p>
            <p>Attached is the latest <code>advantech-EdgeAI/edge_agent</code> traffic CSV.</p>
            <p>â€” GitHub Actions</p>

